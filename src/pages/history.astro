---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/common/Header.astro';
import Footer from '../components/common/Footer.astro';
import { Clock, Package, MapPin, Phone, Mail, CheckCircle } from 'lucide-react';
---

<BaseLayout 
  title="Order History" 
  description="View your past orders and track your food ordering history with Khazaana."
>
  <Header />
  
  <main class="min-h-screen bg-gray-50 py-8">
    <div class="container-custom">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold mb-2">Order History</h1>
        <p class="text-gray-600">View your past orders</p>
      </div>

      <!-- Warning about incognito mode -->
      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg mb-8">
        <div class="flex items-start space-x-3">
          <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
          <div>
            <p class="font-semibold text-yellow-800 mb-1">Order History is Stored Locally</p>
            <p class="text-sm text-yellow-700">
              Your order history is saved in your browser. Do not use incognito mode or clear browser data 
              if you want to keep your order history. Orders are also saved in our system via WhatsApp.
            </p>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-history" class="hidden bg-white rounded-lg shadow-sm p-12 text-center">
        <div class="text-6xl mb-4">ðŸ“¦</div>
        <h2 class="text-2xl font-bold mb-2">No orders yet</h2>
        <p class="text-gray-600 mb-6">Start ordering delicious food from our restaurants!</p>
        <a href="/restaurants/" class="btn-primary inline-block">
          Browse Restaurants
        </a>
      </div>

      <!-- Order List -->
      <div id="order-list" class="space-y-6">
        <!-- Orders will be rendered here by JavaScript -->
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>

<script>
  import { getOrderHistory } from '../lib/cart';
  import { logger } from '../lib/logger';
  import type { Order } from '../types';

  const orders = getOrderHistory();
  
  renderOrderHistory();

  function renderOrderHistory() {
    const emptyHistoryEl = document.getElementById('empty-history');
    const orderListEl = document.getElementById('order-list');

    if (orders.length === 0) {
      if (emptyHistoryEl) emptyHistoryEl.classList.remove('hidden');
      if (orderListEl) orderListEl.innerHTML = '';
      logger.info('Order history is empty', {}, 'HISTORY');
      return;
    }

    if (emptyHistoryEl) emptyHistoryEl.classList.add('hidden');

    if (orderListEl) {
      orderListEl.innerHTML = orders.map((order: Order, index: number) => {
        const orderDate = new Date(order.orderTime);
        const formattedDate = orderDate.toLocaleDateString('en-IN', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        const formattedTime = orderDate.toLocaleTimeString('en-IN', {
          hour: '2-digit',
          minute: '2-digit'
        });

        const deliveryFee = typeof order.deliveryFee === 'number'
          ? order.deliveryFee
          : Math.max(0, order.total - order.subtotal - order.tax);
        const deliveryFeeText = deliveryFee === 0 ? 'FREE' : `â‚¹${deliveryFee.toFixed(2)}`;
        const deliveryFeeClass = deliveryFee === 0 ? 'text-green-600' : 'text-gray-900';

        return `
          <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <!-- Order Header -->
            <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <p class="text-sm opacity-90 mb-1">Order ID</p>
                  <p class="text-xl font-bold">${order.orderId}</p>
                </div>
                <div class="text-right">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white/20">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Sent to WhatsApp
                  </span>
                </div>
              </div>
              
              <div class="flex items-center space-x-4 text-sm opacity-90">
                <div class="flex items-center space-x-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  <span>${formattedDate}</span>
                </div>
                <div class="flex items-center space-x-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span>${formattedTime}</span>
                </div>
              </div>
            </div>

            <!-- Order Details -->
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Restaurant Info -->
                <div>
                  <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-[var(--color-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    Restaurant
                  </h3>
                  <p class="text-lg font-bold text-gray-900">${order.restaurantName}</p>
                </div>

                <!-- Customer Info -->
                <div>
                  <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-[var(--color-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Customer Details
                  </h3>
                  <div class="space-y-1 text-sm text-gray-600">
                    <p><strong>Name:</strong> ${order.customer.name}</p>
                    <p><strong>Phone:</strong> ${order.customer.phone}</p>
                    ${order.customer.email ? `<p><strong>Email:</strong> ${order.customer.email}</p>` : ''}
                  </div>
                </div>
              </div>

              <!-- Delivery Address -->
              <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold text-gray-900 mb-2 flex items-center">
                  <svg class="w-5 h-5 mr-2 text-[var(--color-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  Delivery Address
                </h3>
                <p class="text-gray-700">${order.customer.address}</p>
                ${order.customer.latitude && order.customer.longitude ? `
                  <a 
                    href="https://maps.google.com/?q=${order.customer.latitude},${order.customer.longitude}" 
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-[var(--color-primary)] hover:underline text-sm mt-2 inline-flex items-center"
                  >
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    View on Google Maps
                  </a>
                ` : ''}
              </div>

              <!-- Order Items -->
              <div class="mb-6">
                <h3 class="font-semibold text-gray-900 mb-3">Order Items</h3>
                <div class="space-y-2">
                  ${order.items.map(item => `
                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                      <div class="flex items-center space-x-2 flex-1">
                        ${item.vegNonVeg === 'Veg' 
                          ? '<span class="veg-indicator" title="Vegetarian"></span>'
                          : '<span class="non-veg-indicator" title="Non-Vegetarian"></span>'
                        }
                        <span class="text-gray-700">${item.itemName}</span>
                        <span class="text-gray-500 text-sm">Ã— ${item.quantity}</span>
                      </div>
                      <span class="font-semibold text-gray-900">â‚¹${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                  `).join('')}
                </div>
              </div>

              <!-- Price Summary -->
              <div class="border-t border-gray-200 pt-4">
                <div class="space-y-2 mb-3">
                  <div class="flex justify-between text-gray-700">
                    <span>Subtotal</span>
                    <span>â‚¹${order.subtotal.toFixed(2)}</span>
                  </div>
                  <div class="flex justify-between text-gray-700">
                    <span>Tax</span>
                    <span>â‚¹${order.tax.toFixed(2)}</span>
                  </div>
                  <div class="flex justify-between text-gray-700">
                    <span>Delivery Fee</span>
                    <span class="${deliveryFeeClass}">${deliveryFeeText}</span>
                  </div>
                </div>
                <div class="flex justify-between text-xl font-bold border-t border-gray-200 pt-3">
                  <span>Total</span>
                  <span class="text-[var(--color-primary)]">â‚¹${order.total.toFixed(2)}</span>
                </div>
              </div>

              <!-- Reorder Button -->
              <div class="mt-6">
                <a 
                  href="/restaurants/${order.restaurantId}/" 
                  class="btn-outline w-full block text-center"
                >
                  Order Again from ${order.restaurantName}
                </a>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    logger.info('Order history rendered', { orderCount: orders.length }, 'HISTORY');
  }

  logger.info('Order history page loaded', { orderCount: orders.length }, 'HISTORY');
</script>
